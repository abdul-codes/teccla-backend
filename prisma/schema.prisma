generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model OtpVerification {
  id      String   @id @default(cuid())
  otp     String   @unique
  expires DateTime
  userId  String
  User    User     @relation(fields: [userId], references: [id])

  @@unique([userId, otp])
}

model OtpAttempts {
  id       String   @id @default(cuid())
  attempts Int      @default(0)
  lastTry  DateTime @default(now())
  userId   String   @unique
  User     User     @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  User      User     @relation(fields: [userId], references: [id])
}

model Asset {
  id           String    @id @default(cuid())
  url          String
  publicId     String
  assetType    AssetType
  format       String
  bytes        String
  width        String
  height       String
  uploadedById String
  projectId    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy   User      @relation(fields: [uploadedById], references: [id])

  @@index([projectId])
  @@index([assetType])
}

model Project {
  id                         String        @id @unique @default(cuid())
  title                      String        @unique
  description                String
  location                   String
  budget                     Float
  totalPrice                 Float?
  downPaymentPercentage      Float         @default(50)
  completionPercentage       Float         @default(50)
  type                       ProjectType   @default(COMMERCIAL)
  status                     ProjectStatus
  startDate                  DateTime?
  finishDate                 DateTime?
  isPublic                   Boolean       @default(true)
  maxParticipants            Int?
  createdAt                  DateTime      @default(now())
  updatedAt                  DateTime      @updatedAt
  createdById                String
  asset                      Asset[]
  createdBy                  User          @relation(fields: [createdById], references: [id])
  members                    ProjectMember[]
  projectPayments            ProjectPayment[]
  conversation               Conversation?

  // Performance indexes for filtering and sorting
  @@index([status, createdAt(sort: Desc)]) // For status filtering + date sorting
  @@index([type, createdAt(sort: Desc)]) // For type filtering + date sorting
  @@index([budget]) // For budget range filtering
  @@index([location]) // For location filtering
  @@index([createdById]) // For creator filtering
  @@index([title]) // For search functionality
  @@index([createdAt(sort: Desc)]) // Default sorting optimization
  @@index([startDate(sort: Desc)]) // For project date sorting
  @@index([isPublic])
}

model ProjectMember {
  id           String             @id @default(cuid())
  projectId    String
  userId       String
  role         ProjectMemberRole  @default(MEMBER)
  status       MemberStatus       @default(JOINED)
  joinedAt     DateTime           @default(now())
  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([status])
}

model ProjectPayment {
  id               String         @id @default(cuid())
  projectId        String
  milestoneType    MilestoneType
  requiredAmount   Float
  totalCollected   Float          @default(0)
  numberOfPayments Int            @default(0)
  status           MilestoneStatus @default(PENDING)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payments         Payment[]

  @@unique([projectId, milestoneType])
  @@index([projectId])
  @@index([status])
}

model User {
  id                       String                    @id @unique @default(cuid())
  email                    String                    @unique
  phoneNumber              String?                   @unique
  password                 String
  firstName                String
  lastName                 String
  profilePicture           String?
  role                     UserRole                  @default(USER)
  companyName              String?
  companyRole              String?
  address                  String?
  city                     String?
  state                    String?
  country                  String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  lastLogin                DateTime?
  loginAttempts            Int                       @default(0)
  emailVerified            DateTime?
  userAccountId            String?                   @unique
  assets                   Asset[]
  createdConversations     Conversation[]            @relation("ConversationCreator")
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]                 @relation("MessageSender")
  receivedMessageReads     MessageRead[]
  OtpAttempts              OtpAttempts?
  OtpVerification          OtpVerification[]
  projects                 Project[]
  RefreshTokens            RefreshToken[]
  payments                 Payment[]
  projectMembers           ProjectMember[]

  @@index([email, role, userAccountId])
}

model Conversation {
  id           String                    @id @default(cuid())
  name         String?
  description  String?
  isGroup      Boolean                   @default(false)
  avatar       String?
  createdBy    String
  projectId    String?                   @unique
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  creator      User                      @relation("ConversationCreator", fields: [createdBy], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  project      Project?                  @relation(fields: [projectId], references: [id])

  @@index([createdBy])
  @@index([isGroup])
  @@index([createdAt])
}

model ConversationParticipant {
  id             String          @id @default(cuid())
  conversationId String
  userId         String
  role           ParticipantRole @default(MEMBER)
  joinedAt       DateTime        @default(now())
  lastReadAt     DateTime        @default(now())
  isMuted        Boolean         @default(false)
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageReads   MessageRead[]

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@index([userId, conversationId])
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  messageType    MessageType   @default(TEXT)
  replyToId      String?
  attachmentUrl  String?
  attachmentType String?
  attachmentName String?
  isEdited       Boolean       @default(false)
  editedAt       DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        Message?      @relation("MessageReply", fields: [replyToId], references: [id])
  replies        Message[]     @relation("MessageReply")
  sender         User          @relation("MessageSender", fields: [senderId], references: [id])
  messageReads   MessageRead[]

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([replyToId])
}

model MessageRead {
  id            String                  @id @default(cuid())
  messageId     String
  userId        String
  participantId String
  readAt        DateTime                @default(now())
  message       Message                 @relation(fields: [messageId], references: [id], onDelete: Cascade)
  participant   ConversationParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  user          User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([participantId])
  @@index([userId, messageId])
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  paystackReference String        @unique
  amount            Int
  currency          String        @default("NGN")
  status            PaymentStatus @default(PENDING)
  channel           String?
  cardType          String?
  description       String?
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  projectMemberId   String?
  milestoneType     MilestoneType?
  projectId         String?
  projectPaymentId  String?

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectMember  ProjectMember?  @relation(fields: [projectMemberId], references: [id])
  projectPayment ProjectPayment? @relation(fields: [projectPaymentId], references: [id])

  @@index([userId])
  @@index([paystackReference])
  @@index([status])
  @@index([projectMemberId])
  @@index([projectId])
}

enum UserRole {
  ADMIN
  USER
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
}

enum ProjectType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  INFRASTRUCTURE
  RENOVATION
  MAINTENANCE
  CONSULTING
  OTHER
}

enum AssetType {
  IMAGE
  DOCUMENT
  VIDEO
  OTHER
}

enum ParticipantRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
  SYSTEM
}

enum PaymentStatus {
  SUCCESS
  PENDING
  FAILED
  ABANDONED
  REVERSED
}

enum ProjectMemberRole {
  ADMIN
  MEMBER
}

enum MemberStatus {
  JOINED
  PAID_DOWN
  PAID_COMPLETION
  PAID_FULL
}

enum MilestoneType {
  DOWN_PAYMENT
  COMPLETION
}

enum MilestoneStatus {
  PENDING
  PARTIAL
  FULLY_PAID
}
